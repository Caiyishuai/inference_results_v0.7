## Building
1. Adjust `traits/tiles/arch_stages/modes` in `setup.py` to select only kernels needed
2. python3 setup.py `--clean` (as needed)
3. Makefile.conf relies on the following environment variables
   - `export XMMA=/home/user_name/git/xmma` - only headers from `xmma/include/xmma` are used, building xmma is not required
   - `export CUDA = /usr/local/cuda`
   - `export CUDNN = /usr/local/cudnn`
4. `python3 setup.py`
5. Make sure internal version of CUDA is available (e.g. `/home/scratch.svc_compute_arch/release/cuda_toolkit/internal/cuda-11.0.136-28183248` )
6. `make -j16`
7. `deonv.a` should be built into `xmma_lib/lib`

### Checking out XMMA
``` git clone ssh://git@gitlab-master.nvidia.com:12051/dlarch-fastkernels/xmma.git  ```

## Developement of the deconv lib, based on the impicit_gemm sample in XMMA

### Makefile.config

Below is suitable for both dynamic and static library
1. Add `-fPIC` and `-Xcompiler -fPIC` to `CXX_FLAGS` and `NVCC_FLAGS`
``` 
CXX_FLAGS = $(CXXFLAGS) -O3 -std=c++11 -fPIC -g -fopenmp -DSAMPLES
NVCC_FLAGS := -O3 -Xcompiler -fPIC -std=c++11 -g -lineinfo --use_fast_math -DJETFIRE_ENABLED=1 -ccbin $(CXX) 
```
2. Change `INCLUDE_DIRS`
```
INCLUDE_DIRS := $(CUDA)/include
INCLUDE_DIRS += $(CUDNN)/include
INCLUDE_DIRS += $(XMMA)/include
INCLUDE_DIRS += .
```

### setup.py (i.e. Makefile autogenerated by setup.py)

1. Remove `implicit_gemm` sample from objects
```
# Generate the list of files to compile.
#file.write("OBJECTS  = obj/%s.cpp.o\n" % sample_name)
file.write("OBJECTS  = %s\n" % "")
```
2. Add 
```
all:
	+ $(MAKE) dirs
	+ $(MAKE) bin/implicit_gemm.exe
#new
	+ $(MAKE) lib/deconv.a
```
3. Add more dirs
```
dirs:
\tif [ ! -d lib ]; then mkdir -p lib; fi
\tif [ ! -d include ]; then mkdir -p include; fi
\tcp deconvXmmaApi.h include/.
```
4. Update `clean`
```
clean:
	rm -rf bin obj lib
```
5. Update `icimplicit_gemm` sample dependency. I.e. add `obj/implicit_gemm.cpp.o`
```
bin/implicit_gemm.exe: obj/implicit_gemm.cpp.o $(OBJECTS)
```
6. Add rule to build static lib
```
lib/deconv.a: obj/deconvXmmaApi.cpp.o $(OBJECTS)
  $ar rcs -o $@ $^
```
7. Update `host_workspace` parameters to accomodate for stride
```
host_workspace->xmma_params.img_stride_w =
	host_workspace->xmma_params.img_stride_c * params->nhwc_pitch_c_;
```

8. Copy `implicit_gemm.h`, `samples.h`, `samples_with_cudnn.h` from `xmma/samples` and `xmma/samples/implicit_gemm`

9. Add `nhwc_pitch_c_` field to `Convolution_params` class in `samples.h`

10. Wrapper class in `deconvXmmaApi.cpp` is based on `implicit_gemm.cpp` from `xmma/samples/implicit_gemm`